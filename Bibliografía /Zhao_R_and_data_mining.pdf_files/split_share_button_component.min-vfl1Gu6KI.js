define(["require","exports","tslib","classnames","react-redux","react","spectrum/button","spectrum/popover","spectrum/tooltip","modules/clean/filepath","modules/clean/integrations/data/selectors","modules/clean/react/app_actions/apis","modules/clean/react/app_actions/redirect","modules/clean/react/app_actions/education/types","modules/clean/react/app_actions/telemetry_client","modules/clean/react/css","modules/clean/react/extensions/connect_flow","modules/clean/react/extensions/data/action_creators","modules/clean/react/extensions/data/selectors","modules/clean/react/extensions/data/store","modules/clean/react/extensions/data/types","modules/clean/react/extensions/tooltips","modules/clean/react/extensions/extensions_scaling_modal","modules/clean/react/extensions/utils","modules/clean/react/extensions/extensions_utils","modules/clean/react/extensions/data/helpers","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/file_preview_event_emitter","modules/clean/react/file_viewer/models","modules/clean/react/file_viewer/open_button/types","modules/clean/react/file_viewer_sidebar/buttons/icon","modules/clean/react/portal_popover","modules/clean/static_urls","modules/constants/file_viewer","modules/core/i18n","external/lodash","modules/clean/react/extensions/menu_content_item","modules/clean/cloud_docs/constants","modules/clean/react/extensions/common","modules/clean/user_education/react/user_education_effect"],(function(e,t,n,o,r,i,a,s,l,p,c,u,d,h,g,_,f,m,S,v,A,O,T,P,E,I,x,y,b,C,w,M,k,N,L,B,D,F,U,V){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),o=n.__importDefault(o),i=n.__importStar(i);var R="TOOLTIP_ONLY"===N.FILES_2_COLLAPSED_SHARE_COPY_TOOLTIP_CHANGES,H="COPY_ONLY"===N.FILES_2_COLLAPSED_SHARE_COPY_TOOLTIP_CHANGES,G="COPY_AND_TOOLTIP"===N.FILES_2_COLLAPSED_SHARE_COPY_TOOLTIP_CHANGES;v.getStore();var Y=(function(e){function t(t){var r=e.call(this,t)||this;return r.handleClickShare=function(e){e.preventDefault(),r.props.onShowShare(),r.props.logShareButtonClick&&r.props.logShareButtonClick(),r.currentSession&&r.currentSession.event("click_share",{trigger_type:r.props.triggerType}),e.stopPropagation()},r.handleSelectAction=function(e,t){t.preventDefault(),e.handler(),r.props.logShareButtonClick&&r.props.logShareButtonClick(e.userAction),U.logEvent(r.currentSession,"select_action",{type:e.type,trigger_type:r.props.triggerType}),t.stopPropagation()},r.handlePreventMouseDown=function(e){e.preventDefault(),r.state.tooltipState===h.TooltipState.BIG_ONBOARDING_TOOLTIP&&(r.markSplitShareTooltipViewed(),r.setState({tooltipState:h.TooltipState.NO_TOOLTIP})),e.stopPropagation()},r.handlePopoverHover=function(){r.currentSession&&r.currentSession.event("popover_trigger_hover",{trigger_type:r.props.triggerType})},r.handleShareHover=function(){r.currentSession&&r.currentSession.event("share_hover",{trigger_type:r.props.triggerType})},r.handlePopoverToggle=function(e){var t=e.isOpen,n=r.props,o=n.onDropdownOpen,i=n.onDropdownClose,a=n.triggerType,s=n.isCollapsed;if(t&&o?o():!t&&i&&i(),r.currentSession&&r.currentSession.event(t?"open_popover":"close_popover",{trigger_type:a}),t){var l=s?x.EventType.SidebarCollapsedShareClicked:x.EventType.SidebarOpenedShareClicked;y.filePreviewEventEmitter.emit(l,b.FilePreviewSession.currentSession)}},r.handlePresentInZoom=function(e,t){var n=r.props,o=n.refreshSharingServiceInfo,i=n.sharingServiceInfo,a=n.onPresentInZoom,s=n.landingPageEnabled;i&&o&&a&&f.presentInZoomFlow(e,i,o,a,"split_share_button",s,t)},r.handleShareInSlack=function(e,t,n){var o=r.props,i=o.refreshSharingServiceInfo,a=o.sharingServiceInfo,s=o.landingPageEnabled;a&&i&&f.shareInSlackFlow(t,a,i,e,"split_share_button",s,n)},r.handleShareToTrello=function(e,t,n){var o=r.props,i=o.refreshSharingServiceInfo,a=o.sharingServiceInfo,s=o.landingPageEnabled;a&&i&&f.shareInTrelloFlow(t,a,i,e,"split_share_button",s,n)},r.handleUpdateLinkState=function(e,t){(0,r.props.updateLinkState)({actionId:e,linkState:t})},r.handleAppAction=function(e,t,n){var o=r.props,i=o.context,a=o.featureFlags;d.redirectToActionOrShowAuth(t,e,n,a,i,r.handleUpdateLinkState,r.handleShareAction),U.logEvent(r.currentSession,"select_action",U.getAppActionExtras(n))},r.handleShareAction=function(e,t,n){var o=n.handler.service_type[".tag"],i={".tag":"profile_linked"},a=function(){r.handleUpdateLinkState(n.id,i),d.authorizeNoRedirect(e,n.id)};switch(o){case"slack_dropbox":return r.handleShareInSlack(t,e,a);case"zoom":return r.handlePresentInZoom(e,a);case"trello":return r.handleShareToTrello(t,e,a)}},r.getAppActionIconUrl=function(e){var t=e.icon;return t&&t.url&&!t.is_static?t.url:k.static_url("/static/images/generic_app_icon-vflIPYT1H.png")},r.getAppActionOpenOptionActions=function(e){var t=e.handler;if("profile_service"!==t[".tag"])return{type:C.OpenButtonAction.APP_ACTION,userAction:x.UserAction.ShareToAction};switch(t.service_type[".tag"]){case"slack_dropbox":return{type:C.OpenButtonAction.SHARE_TO_SLACK,userAction:x.UserAction.ShareToSlack};case"zoom":return{type:C.OpenButtonAction.PRESENT_IN_ZOOM,userAction:x.UserAction.PresentInZoom};case"trello":return{type:C.OpenButtonAction.SHARE_TO_TRELLO,userAction:x.UserAction.ShareToTrello};default:return{type:C.OpenButtonAction.APP_ACTION,userAction:x.UserAction.ShareToAction}}},r.getAppActionOpenOption=function(e,t,n){var o=r.getAppActionOpenOptionActions(n),i=o.type,a=o.userAction;return{handler:function(){return r.handleAppAction(e,t,n)},spriteName:null,text:n.description,type:i,userAction:a,iconUrl:r.getAppActionIconUrl(n)}},r.getMoreAppsOpenOption=function(e,t){return{handler:function(){r.handleMoreApps(e,t),U.logEvent(r.currentSession,"select_show_more",{})},text:L.intl.formatMessage({defaultMessage:"Connect more apps",description:"Connect more apps"}),type:C.OpenButtonAction.OPEN_MORE_APPS,userAction:x.UserAction.OpenMoreApps,spriteName:null}},r.getAddAppsOpenOption=function(e,t){return{handler:function(){r.handleMoreApps(e,t),U.logEvent(r.currentSession,"select_add_apps",{})},text:L.intl.formatMessage({defaultMessage:"Connect apps",description:"Connect apps"}),type:C.OpenButtonAction.OPEN_ADD_APPS,userAction:x.UserAction.OpenAddApps,spriteName:null,iconUrl:k.static_url("/static/images/extensions/circled_plus-vfl7N2-Lg.svg")}},r.handleMoreApps=function(e,t){var n=r.props,o=n.appActions,i=n.featureFlags,a=n.context,s=n.categoryInfo,l=E.getCategoryIdToInfos(s);T.showExtensionsScalingModal(L.intl.formatMessage({defaultMessage:"Share with these apps",description:"Share with these apps"}),t,e,o.sort(I.actionCompareFn),l,i,r.handleUpdateLinkState,a,r.currentSession,r.handleShareAction)},r.getShareWithEmailOpenOption=function(){return{handler:r.props.onShowShare,spriteName:null,text:L.intl.formatMessage({defaultMessage:"Share with Dropbox",description:"Share with Dropbox"}),type:C.OpenButtonAction.INVITE_VIA_EMAIL,userAction:x.UserAction.InviteViaEmail,iconUrl:k.static_url("/static/images/extensions/shared_medium-vfldEW5Iw.svg")}},r.getPopoverTriggerRenderer=function(e,t,n){return function(){var s=H||G?i.default.createElement("img",{alt:"",src:k.static_url("/static/images/extensions/shared_light-vfl8nVEY_.svg")}):i.default.createElement(w.ButtonIcon,{isPrimary:"primary"===r.getButtonVariant(),name:"share","aria-label":n}),p=i.default.createElement(a.Button,{className:o.default("extensions-split-share-menu__trigger",{"extensions-split-share-menu__trigger--collapsed":e}),tagName:"span",tabIndex:t?void 0:-1,variant:r.getButtonVariant(),onMouseEnter:r.handlePopoverHover,"aria-label":L.intl.formatMessage({defaultMessage:"Expand share menu",description:"Expand share menu"})},e?s:"â–¾");return(R||G)&&e?i.default.createElement(l.Tooltip,{positionOffset:8,positioning:"left",tooltipContent:L.intl.formatMessage({defaultMessage:"Share",description:"Share"})},p):p}},r.getPopoverItemRenderer=function(){return function(){var e=r.props,t=e.user,n=e.file,o=e.appActions,a=e.featureFlags.expSplitShareBtn,l=r.getShareWithEmailOpenOption(),p="ON_SHOW_INVITE"===a?i.default.createElement(i.Fragment,null,i.default.createElement(D.MenuContentItem,{openOption:l}),i.default.createElement(s.PopoverItemGroupSeparator,null)):null,c=I.partitionActions(o),u=c.installedActions,d=c.unpromotedActions,h=B.isEmpty(u)?null:u.map((function(e){var o=r.getAppActionOpenOption(n,t,e);return i.default.createElement(D.MenuContentItem,{key:o.text,openOption:o})})),g=B.isEmpty(d)?null:i.default.createElement(D.MenuContentItem,{openOption:B.isEmpty(u)?r.getAddAppsOpenOption(n,t):r.getMoreAppsOpenOption(n,t)});return i.default.createElement(i.Fragment,null,p,h,g)}},r.markSplitShareTooltipViewed=function(){u.markTooltipViewed(r.props.user.id,"split_share_edu")},r.state={tooltipState:h.TooltipState.NO_TOOLTIP},r.telemetryClient=g.createTelemetryClient(n.__assign({component:"split-share-btn"},t.context)),r}return n.__extends(t,e),t.prototype.componentDidMount=function(){this.props.showEduTooltip&&this.setEduTooltip()},t.prototype.setEduTooltip=function(){return n.__awaiter(this,void 0,void 0,(function(){var e,t;return n.__generator(this,(function(n){switch(n.label){case 0:return[4,u.getTooltipHistory(this.props.user.id,["open_with_edu","split_share_edu"])];case 1:return e=n.sent(),t=O.allowedTooltips(this.props.appActions.length>0,this.props.file.fq_path?"."+p.file_extension(p.filename(this.props.file.fq_path)):"",this.props.featureFlags),"split_share_edu"===t.find((function(t){return void 0!==e[t]&&!e[t]}))&&this.setState({tooltipState:h.TooltipState.BIG_ONBOARDING_TOOLTIP}),[2]}}))}))},t.prototype.getButtonVariant=function(){var e=this.props,t=e.isVisible,n=e.variant;return n&&t?n:"invisible"},t.prototype.render=function(){var e=this.props,t=e.file,n=e.context,r=e.isVisible,l=e.shareButtonLabel,c=e.triggerType,u=e.isCollapsed,d=e.shouldUsePortalPopover,h=e.appActions,_=e.scrollableSidebarRef,f=e.featureFlags,m="ON_SHOW_INVITE"===(null==f?void 0:f.expSplitShareBtn)||!B.isEmpty(h);n?this.currentSession=this.telemetryClient.session({ext:g.getPiiSafeExtension(t?"."+p.file_extension(p.filename(t.fq_path)):"")}):delete this.currentSession;var S=o.default("extensions-split-share__share-button",{"primary-action-menu__button":c===A.TriggerType.SidebarPrimaryButton,"extensions-inline-share-button":m,"action-share":!m}),v=i.default.createElement(a.Button,{"aria-label":l,className:S,onClick:this.handleClickShare,tabIndex:r?void 0:-1,variant:this.getButtonVariant(),onMouseEnter:this.handleShareHover},i.default.createElement(V.UserEducationEffect,{containerName:"SplitShareButton",name:"ShareButtonLabel",useSpan:!0},l)),O=this.getPopoverTriggerRenderer(u,r,l),T=this.getPopoverItemRenderer(),E=d?i.default.createElement(M.PortalPopover,{className:"extensions-split-share__popover",popoverTriggerSelector:".extensions-split-share-menu__trigger",renderPopoverTrigger:O,renderPopoverItems:T,scrollableContainer:_,onSelection:this.handleSelectAction,onMenuToggle:this.handlePopoverToggle,onClick:this.handlePreventMouseDown,onDoubleClick:this.handlePreventMouseDown}):i.default.createElement(s.Popover,{className:"extensions-split-share__popover",onClick:this.handlePreventMouseDown,onDoubleClick:this.handlePreventMouseDown,onSelection:this.handleSelectAction,onMenuToggle:this.handlePopoverToggle,closeOnSelection:!0},i.default.createElement(s.PopoverTrigger,null,O()),i.default.createElement(s.PopoverContent,{position:"below",attachment:"right"},T())),I=this.props.sharingServiceInfo&&P.isSlackAvailable(this.props.sharingServiceInfo)&&P.isZoomAvailable(this.props.sharingServiceInfo);return i.default.createElement("div",{className:o.default("extensions-split-share-btn",{"extensions-split-share-btn--invisible":!r,"slack-zoom-available":I&&!u,"slack-zoom-available-collapsed":I&&u,"wopi-available":("V1_WOPI"===(null==f?void 0:f.cloudDocPrompt)||"V2_AGNOSTIC"===(null==f?void 0:f.cloudDocPrompt))&&F.isMicrosoftFileByExtension(p.file_extension(p.filename(this.props.file.fq_path)))&&!u})},u?null:v,m?E:null)},t.defaultProps={isVisible:!0,shareButtonLabel:L.intl.formatMessage({defaultMessage:"Share",description:"Share"}),triggerType:A.TriggerType.PrimaryButton,variant:"secondary"},t})(i.default.Component);t.SplitShareButtonComponent=Y;var Z={refreshSharingServiceInfo:m.refreshSharingServiceInfoAdapter,updateLinkState:m.updateLinkState},q=r.connect((function(e,t){return{appActions:S.getShareActionsForFile(e,n.__assign(n.__assign({},t.file),{bytes:0})),categoryInfo:S.getCategoryInfos(e),featureFlags:S.getFeatureFlags(e),sharingServiceInfo:S.getSharingServiceInfoAdapter(e),landingPageEnabled:c.isConnectServiceLandingPagesEnabled(e)}}),Z)(Y);t.SplitShareButton=_.requireCssWithComponent(q,["/static/css/extensions/index-vflpbukXI.css","/static/css/app_actions/index-vfle4rJAa.css"])}));
//# sourceMappingURL=split_share_button_component.min.js-vflDNAnnO.map