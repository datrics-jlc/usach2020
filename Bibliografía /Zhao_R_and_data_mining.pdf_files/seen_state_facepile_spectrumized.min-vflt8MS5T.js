define(["require","exports","tslib","modules/core/i18n","classnames","react","prop-types","external/lodash","deep-integrations/data/user_settings","modules/clean/file_store/utils","modules/clean/loggers/pass_facepile_logger","modules/clean/integrations/data/store","modules/clean/react/css","modules/clean/react/file_viewer/share_helpers","modules/clean/react/pass/tooltip_helpers","modules/core/window","modules/clean/static_urls","modules/clean/react/modal","modules/clean/teams/admin/widgets/invite_modal/invite_modal","modules/clean/teams/suggest_invites_modal","modules/clean/analytics","modules/clean/react/pass/avatars","modules/clean/react/pass/constants","modules/clean/react/pass/event_emitter","modules/clean/react/pass/empty_seen_state_facepile","modules/clean/react/pass/utils","modules/clean/react/pass/types","modules/clean/react/size_class/constants","modules/clean/sharing/constants","modules/clean/viewer","modules/core/user_i18n","comments2/components/rich_facepile","modules/clean/react/comments2/components/comments_translations","spectrum/facepile","modules/clean/contacts/contact"],(function(e,t,s,n,r,a,o,i,p,u,l,c,m,d,f,h,_,g,v,S,y,w,I,E,C,T,L,P,A,x,U,V,O,b,F){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r=s.__importDefault(r),a=s.__importDefault(a),o=s.__importStar(o),i=s.__importStar(i),d=s.__importStar(d),U=s.__importStar(U);var M=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state={newPresentUserIds:[]},t.hasPassShownBeenLogged=!1,t.onAvatarHover=function(e){t.logPassEvent(I.EventTypes.PASS_HOVER),e!==V.OVERFLOW&&t.hasTeamExpandInfo(e.memberKey)&&y.TeamsWebActionsLogger.log("team_expand_info_shown",{user_id:e.memberKey})},t.hasTeamExpandInfo=function(e){if(!f.getOnVsOffTeamExperiment())return!1;var s=t.getUserInfoList().find((function(t){return t.key===e}));return Boolean(s&&t.getTeamExpandForUserInfo(s).teamExpandButtonText)},t.openShareModal=function(){d.share(t.props.file,x.Viewer.get_viewer().get_user_by_id(t.props.user.id),t.props.url||null,A.SHARE_ACTION_ORIGIN_TYPE.PREVIEW_PAGE_FACEPILE)},t.onAvatarClick=function(e){t.logPassEvent(I.EventTypes.PASS_CLICK);var s=t.context.getIntegrationStore(),n=t.getPromptsToDismiss(s);n.length>0&&c.wrapDispatch(s.dispatch)(p.dismissPrompts(n)),e===V.OVERFLOW&&t.openShareModal()},t.onTooltipChange=function(e,s){e.activeMode;var n=e.displayInfo,r=(s.activeMode,s.displayInfo);null!==r&&n!==r&&t.onAvatarHover(r)},t.canShowPASS=function(){var e=t.props,s=e.isPassPermissionsPending,n=e.passFetchingStatus,r=e.passPermissions;return!s&&n!==I.PassFetchingStatus.ERROR&&null!==r&&(r.canReadPresence||r.canReadSeenState)},t.canShowMembershipInfo=function(){var e=t.props.sharingStorePassInfo;return e.isLoaded&&null!==e.data&&e.data.users.length>0&&f.getOnVsOffTeamExperiment()&&!f.getOnVsOffTeamLimitedVariant()},t.getTeamExpandForUserInfo=function(e){var s=t.props,r=s.joinableTeams,o=s.joinTeamHandler,i=s.user,p=x.Viewer.get_viewer(),u=p.team_id,l=p.team_type,c=p.team_name;if(i.is_team_admin&&!1===e.same_team&&!1===e.is_guest)return{teamExpandPrimaryText:n.intl.formatMessage(f.notOnTeamLabel,{teamname:c}),teamExpandButtonText:f.inviteToTeamLabel,teamExpandReasonsText:f.buildTeamExpandReasons(e),teamExpandButtonHandler:function(){h.sendBrowserAgnosticEvent(window,"resize"),g.Modal.showInstance(a.default.createElement(v.InviteModal,{emails:e.email?[e.email]:[],origin:"pass"})),y.TeamsWebActionsLogger.log("pass_invite_user",{user_id:i.id,team_id:u})}};if(i.is_team&&!1===e.same_team&&!1===e.is_guest)return{teamExpandPrimaryText:n.intl.formatMessage(f.notOnTeamLabel,{teamname:c}),teamExpandButtonText:f.inviteToTeamLabel,teamExpandReasonsText:f.buildTeamExpandReasons(e),teamExpandButtonHandler:function(){u&&l?(h.sendBrowserAgnosticEvent(window,"resize"),g.Modal.showInstance(a.default.createElement(S.SuggestInvitesModal,{teamId:u,teamType:l,populatedContacts:e.email?[F.Contact.buildFromRawEmail(e.email)]:[],source:"pass"}))):T.navigateToSuggestModal(e.email?[e.email]:[]),y.TeamsWebActionsLogger.log("pass_suggested_user",{user_id:i.id,team_id:u,team_type:l})}};if(!i.is_team&&r&&o)for(var m=function(t){for(var s=0,r=t.members;s<r.length;s++){var a=r[s];if(e.userId===a.memberId)return{value:{teamExpandPrimaryText:n.intl.formatMessage(f.onTeamLabel,{teamname:t.name}),teamExpandButtonText:f.joinTeamLabel,teamExpandButtonHandler:function(){h.sendBrowserAgnosticEvent(window,"resize"),o(t),y.TeamsWebActionsLogger.log("pass_requested_access_to_team",{user_id:i.id,team_id:t.id})},showCompanyIcon:!0}}}},d=0,_=r;d<_.length;d++){var w=m(_[d]);if("object"==typeof w)return w.value}return{}},t}return s.__extends(t,e),t.prototype.componentWillMount=function(){this.resetLogging(),l.passFacepileLogger.listenTo(E.passEventEmitter)},t.prototype.componentDidMount=function(){this.logFacepileShownEvents()},t.prototype.componentWillReceiveProps=function(e){if(u.areFilesEqual(this.props.file,e.file)){if(null==e.presence||null==this.props.presence)return;var t=i.difference(e.presence,this.props.presence),s=i.difference(this.props.presence,e.presence);this.updateNewPresentUserIds(t,s)}else this.setState({newPresentUserIds:[]}),this.resetLogging()},t.prototype.componentDidUpdate=function(e){this.logFacepileShownEvents()},t.prototype.componentWillUnmount=function(){l.passFacepileLogger.unlistenTo(E.passEventEmitter)},t.prototype.updateNewPresentUserIds=function(e,t){var n=i.filter(this.state.newPresentUserIds,(function(e){return-1===t.indexOf(e)}));this.setState({newPresentUserIds:s.__spreadArrays(e,n)})},t.prototype.computeOverflowBasis=function(e){if(!this.props.uniqueMemberCountInfo.data)return e.length;var t=this.props.uniqueMemberCountInfo.data;return e.forEach((function(e){e.incrementOverflowBasis&&++t})),Math.max(t,e.length)},t.prototype.resetLogging=function(){this.hasPassShownBeenLogged=!1},t.prototype.logFacepileShownEvents=function(){if(!this.hasPassShownBeenLogged&&this.dataSufficientForLoggingHasLoaded()){var e=this.getUserInfoList();this.haveSeenStateDataToShow(e)&&(this.logPassEvent(I.EventTypes.PASS_SHOWN,e),this.hasPassShownBeenLogged=!0)}},t.prototype.logPassEvent=function(e,t){var s=this.props,n=s.anonymousPresenceInfo.length,r=s.file,a=s.passPermissions,o=this.getViewerCountByAccessLevel(),i=o.numViewers,p=o.numInTeamEditors,u=o.numInTeamViewers,l=o.numNonTeamEditors,c=o.numNonTeamViewers,m=this.computeOverflowBasis(t||this.getUserInfoList());return E.passEventEmitter.emit(e,!1,r,{numAccessors:m,numViewers:i,numCurrentViewers:this.getNumCurrentViewers(),canSeeViewerHistory:a&&a.canReadSeenState,numGuests:n,numInTeamEditors:p,numInTeamViewers:u,numNonTeamEditors:l,numNonTeamViewers:c})},t.prototype.getViewerCountByAccessLevel=function(){var e,t,s=this,n=0,r=0,a=0,o=0;if(this.shouldHardcodeCurrentViewer()){t=this.seenStateDataWithViewerFiltered(this.getSeenStates());var i=this.getSeenStates().filter((function(e){return e.seen_state_user.user_id===s.props.user.account_id}));if(i.length>0){e=0;var p=i[0];p.when_last_seen=1,t.push(p)}else e=1,n++}else e=0,t=this.getSeenStates();for(var u=0,l=t;u<l.length;u++){var c=l[u];if(null!=c.when_last_seen){e++;var m=c.seen_state_user;m.in_owners_team?m.sharing_access_type&&"edit_member_access"===m.sharing_access_type.type?n++:r++:m.sharing_access_type&&"edit_member_access"===m.sharing_access_type.type?a++:o++}}return{numViewers:e,numInTeamEditors:n,numInTeamViewers:r,numNonTeamEditors:a,numNonTeamViewers:o}},t.prototype.getNumCurrentViewers=function(){var e=this;return this.props.presence?this.shouldHardcodeCurrentViewer()?1+this.props.presence.filter((function(t){return t!==e.props.user.account_id})).map((function(e){return e})).length:this.props.presence.length:0},t.prototype.userIsAnonymous=function(e){return i.map(this.props.anonymousPresenceInfo,(function(e){return e.seen_state_user.user_id})).indexOf(e.user_id)>=0},t.prototype.userIsOnline=function(e){return null!=this.props.presence&&this.props.presence.indexOf(e.user_id)>=0},t.prototype.buildUserInfo=function(e){var t=e.platform_type,s=e.seen_state_user,n=e.seen_state_user,r=n.access_level,a=n.display_name,o=n.email,i=n.photo_circle_url,p=n.sharing_access_type,u=n.user_id,l=n.same_team,c=e.when_last_seen,m=u||a,d=T.shouldIncrementOverflowBasisForAccessType(p),h=f.getOnVsOffTeamExperiment(),g=this.userIsAnonymous(s),v=h&&!1===l&&this.props.user.is_team&&!g;return new L.UserInfo(m,a,this.userIsOnline(s),!1,d,o,r,c,v?_.static_url("/static/images/team_success/pass/nonteam_member_white-vflnM3nw0.svg"):i,u,t,l,g)},t.prototype.seenStateDataWithViewerFiltered=function(e){var t=this;return i.filter(e,(function(e){return e.seen_state_user.user_id!==t.props.user.account_id}))},t.prototype.partitionUserInfoLists=function(e){for(var t=[],s=[],n=[],r=[],a=[],o={},i=0,p=e;i<p.length;i++){var u=p[i],l=this.buildUserInfo(u);this.userIsOnline(u.seen_state_user)?this.isNewPresentUser(l)?o[l.key]=l:this.userIsAnonymous(u.seen_state_user)?n.push(l):s.push(l):null!=u.when_last_seen?r.push(l):a.push(l)}for(var c=0,m=this.state.newPresentUserIds;c<m.length;c++){(l=o[m[c]])&&t.push(l)}return{newPresentUserInfoList:t,presentUserInfoList:s,anonymousUserInfoList:n,offlineUserInfoList:r,neverViewedUserInfoList:a}},t.prototype.getUserInfoList=function(){var e,t=[],n=this.getMergedSeenStateData();if(this.shouldHardcodeCurrentViewer()){e=this.seenStateDataWithViewerFiltered(n);var r=this.props.user.account_id,a=e.length<n.length&&this.getSeenStates().some((function(e){var t=e.seen_state_user;return t.user_id===r&&T.shouldIncrementOverflowBasisForAccessType(t.sharing_access_type)})),o=x.Viewer.get_viewer().get_user_by_id(this.props.user.id);t.push(new L.UserInfo(this.props.user.account_id,o.display_name,this.canShowPASS(),!0,a,o.email,void 0,void 0,o.photo_url,this.props.user.account_id,void 0,!0,!1))}else e=n;var i=this.partitionUserInfoLists(e),p=i.newPresentUserInfoList,u=i.presentUserInfoList,l=i.anonymousUserInfoList,c=i.offlineUserInfoList,m=i.neverViewedUserInfoList;return u.sort((function(e,t){return e.displayName.toLowerCase().localeCompare(t.displayName.toLowerCase())})),m.sort((function(e,t){return e.displayName.toLowerCase().localeCompare(t.displayName.toLowerCase())})),s.__spreadArrays(t,p,u,l,c,m)},t.prototype.isNewPresentUser=function(e){return this.state.newPresentUserIds.indexOf(e.key)>=0},t.prototype.getMergedSeenStateData=function(){var e=this.getSeenStates(),t=e.map((function(e){return e.seen_state_user.user_id}));if(this.props.sharingStorePassInfo.data){for(var n=0,r=this.props.sharingStorePassInfo.data.users;n<r.length;n++){var a=r[n],o=a.seen_state_user.user_id;-1!==t.indexOf(o)||o===this.props.user.account_id&&this.shouldHardcodeCurrentViewer()||e.push(a)}return s.__spreadArrays(e,this.props.anonymousPresenceInfo,this.props.sharingStorePassInfo.data.invitees)}return s.__spreadArrays(e,this.props.anonymousPresenceInfo)},t.prototype.shouldHardcodeCurrentViewer=function(){var e=!x.Viewer.get_viewer().is_assume_user_session,t=null!=this.props.presence&&this.props.presence.indexOf(this.props.user.account_id)>=0;return e||t},t.prototype.getSeenStates=function(){return this.props.identifiedSeenStateInfo&&this.props.identifiedSeenStateInfo.seen_states?s.__spreadArrays(this.props.identifiedSeenStateInfo.seen_states):[]},t.prototype.haveSeenStateDataToShow=function(e){var t=e.length;return t>=2||1===t&&e[0].key!==this.props.user.account_id},t.prototype.dataSufficientForLoggingHasLoaded=function(){return this.sharingAndCountInfoHasLoaded()&&I.fetchingStatusCanLogAsShown(this.props.passFetchingStatus)},t.prototype.dataSufficientForDisplayHasLoaded=function(){return this.sharingAndCountInfoHasLoaded()&&I.fetchingStatusSeenStateIsComplete(this.props.passFetchingStatus)},t.prototype.sharingAndCountInfoHasLoaded=function(){var e=this.props,t=e.sharingStorePassInfo,s=e.uniqueMemberCountInfo;return t.isLoaded&&s.isLoaded},t.prototype.getPromptsToDismiss=function(e){return[{".tag":"tooltip_click_for_more"},{".tag":"tooltip_click_for_more_auto_display"}].filter((function(t){return!c.isPromptDismissed(e.getState(),t[".tag"])}))},t.prototype.render=function(){var e,t=this.props.isCollapsed;if(!this.canShowPASS()&&!this.canShowMembershipInfo())return this.renderEmptyFacepile();if(!this.dataSufficientForDisplayHasLoaded())return a.default.createElement("div",null);var s=this.getUserInfoList();if(this.haveSeenStateDataToShow(s)){if(t)return this.renderCollapsedFacepile(s[0]);var n=this.computeOverflowBasis(s);return a.default.createElement("div",{className:this.facepileClassName()},a.default.createElement(V.RichFacepile,{avatarInfoList:this.computeAvatarInfos(s),becomePassiveOnOverflowAvatarClick:!0,passiveShowOnHover:f.getOnVsOffTeamExperiment(),intl:O.commentsMasterLocalization.intl,onAvatarClick:this.onAvatarClick,onTooltipChange:this.onTooltipChange,overflowBasis:n,sizeClass:this.getConvertedSizeClass(),sizeClassToCircleCountOverrides:(e={},e[V.SizeClass.Small]=0,e[V.SizeClass.Large]=3,e),tooltipComponent:V.UtilTooltip}))}return this.renderEmptyFacepile()},t.prototype.getConvertedSizeClass=function(){switch(this.props.sizeClass){case P.SizeClass.Small:return V.SizeClass.Small;case P.SizeClass.Medium:return V.SizeClass.Medium;case P.SizeClass.Large:return V.SizeClass.Large;case P.SizeClass.ExtraLarge:return V.SizeClass.ExtraLarge}},t.prototype.renderEmptyFacepile=function(){return a.default.createElement(C.EmptySeenStateFacepile,{presenceComplete:!this.props.isPassPermissionsPending})},t.prototype.renderCollapsedFacepile=function(e){var t=e.isActive,s=e.displayName,n=e.photoUrl;return a.default.createElement(b.FacepileMembersAvatar,{active:t,avatarColorSeed:s,avatarSize:32,initials:U.getInitials(s),photoUrl:n||null,disabled:!0})},t.prototype.facepileClassName=function(){var e;return r.default(I.FACEPILE_CLASSNAME,((e={})[I.PRESENCE_RECEIVED_CLASSNAME]=!this.props.isPassPermissionsPending,e))},t.prototype.computeAvatarInfos=function(e){var t=this;if(0===e.length)return[];var n=this.context.getIntegrationStore(),r=this.context.logEvent(),o=this.context.performanceTimer(),i=this.context.reportError(),p=this.props,l=p.file,c=p.file.file_id,m=p.user.id,d=u.getFilename(l),h=f.getOnVsOffTeamExperiment();return e.slice(0,V.MAX_FACES).map((function(e){var p,u,l=(function(e){var t=e.userId,s=e.displayName;return t&&T.AnonymousViewerUtils.isAnonymousUserId(t)?{colorSeed:t,initials:T.AnonymousViewerUtils.getAnonymousViewerInitials(s)}:{colorSeed:s,initials:U.getInitials(s)}})(e),f=l.colorSeed,_=l.initials,g=e.isActive,v=e.displayName,S=e.key,y=e.userId,I=e.photoUrl,E=h?t.getTeamExpandForUserInfo(e):{},C=a.default.createElement(w.UserAvatarActiveTooltipContent,s.__assign({colorSeed:f,integrationStore:n,integrationInfo:{fileId:c,fileName:d,userId:m},logEvent:r,performanceTimer:o,reportError:i,userInfo:e},E));return h?(p=C,u=void 0):(u=C,p=a.default.createElement(w.UserAvatarPassiveTooltipContent,{colorSeed:f,integrationStore:n,userInfo:e})),{present:g,displayName:v,avatarColorSeed:f,initials:_,memberKey:S,photoUrl:I||null,userId:y,passiveTooltipContent:p,activeTooltipContent:u}}))},t.contextTypes={getIntegrationStore:o.func,logEvent:o.func,performanceTimer:o.func,reportError:o.func},t})(a.default.Component);t.SeenStateFacepileComponentSpectrumized=M,t.SeenStateFacepileSpectrumized=m.requireCssWithComponent(M,["/static/css/seen_state_facepile-vflstHtiR.css","/static/js/deep-integrations/index.web-vfljUWtjs.css","/static/js/comments2/index.web-vflV6GXjO.css"])}));
//# sourceMappingURL=seen_state_facepile_spectrumized.min.js-vflZNi5qa.map